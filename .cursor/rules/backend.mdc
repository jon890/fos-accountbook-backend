# ğŸ—ï¸ ìš°ë¦¬ì§‘ ê°€ê³„ë¶€ - Backend ê°œë°œ ê·œì¹™

## ğŸ“š ê¸°ìˆ  ìŠ¤íƒ

- **Framework**: Spring Boot 3.x
- **Language**: Java 21
- **ORM**: JPA (Hibernate)
- **Database**: MySQL (Production), H2 (Test)
- **Migration**: Flyway
- **Build Tool**: Gradle (Kotlin DSL)
- **Documentation**: Swagger/OpenAPI

---

## ğŸ›ï¸ ì•„í‚¤í…ì²˜

### ê³„ì¸µ êµ¬ì¡° (Layered Architecture)

```
Presentation (Controller, DTO)
    â†“
Application (Service, DTO)
    â†“
Domain (Entity, Repository Interface, Value Object)
    â†“
Infrastructure (JPA Repository Implementation)
```

### íŒ¨í‚¤ì§€ êµ¬ì¡°

```
com.bifos.accountbook
â”œâ”€â”€ presentation
â”‚   â”œâ”€â”€ controller          # REST API ì—”ë“œí¬ì¸íŠ¸
â”‚   â”œâ”€â”€ dto                 # Request/Response DTO
â”‚   â””â”€â”€ annotation          # @LoginUser ë“±
â”œâ”€â”€ application
â”‚   â”œâ”€â”€ service             # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â””â”€â”€ dto                 # Service ë ˆì´ì–´ DTO
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ entity              # JPA Entity
â”‚   â”œâ”€â”€ repository          # Repository ì¸í„°í˜ì´ìŠ¤ (ìˆœìˆ˜ ë„ë©”ì¸)
â”‚   â””â”€â”€ value               # Value Object (CustomUuid ë“±)
â””â”€â”€ infra
    â””â”€â”€ persistence
        â””â”€â”€ repository      # JPA Repository êµ¬í˜„ì²´
```

---

## ğŸ“ ì½”ë”© ì»¨ë²¤ì…˜

### 1. ì—”í‹°í‹° ê·œì¹™

```java
@Entity
@Table(name = "user_profiles")  // âœ… snake_case í•„ìˆ˜
public class UserProfile {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;  // âœ… PKëŠ” Long auto_increment
    
    @Column(name = "user_uuid", nullable = false)  // âœ… snake_case
    private CustomUuid userUuid;  // âœ… ê´€ê³„ëŠ” UUID ê¸°ë°˜
    
    @Column(name = "timezone")
    private String timezone;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
    
    @Column(name = "deleted_at")  // âœ… Soft Delete
    private LocalDateTime deletedAt;
}
```

**í•µì‹¬:**
- í…Œì´ë¸”ëª…/ì»¬ëŸ¼ëª…: `snake_case` í•„ìˆ˜
- PK: `Long id` (auto_increment)
- ê´€ê³„: UUID ê¸°ë°˜ (`user_uuid`, `family_uuid`)
- Soft Delete: `deleted_at` ì»¬ëŸ¼ ì‚¬ìš©
- Lombok: `@Builder`, `@Getter`, `@NoArgsConstructor`, `@AllArgsConstructor`

---

### 2. Repository íŒ¨í„´

```java
// Domain Layer - ì¸í„°í˜ì´ìŠ¤ë§Œ
public interface UserRepository {
    User save(User user);
    Optional<User> findByUuid(CustomUuid uuid);
}

// Infrastructure Layer - êµ¬í˜„ì²´
@Repository
public class UserJpaRepository implements UserRepository {
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public User save(User user) {
        // JPA êµ¬í˜„
    }
}
```

---

### 3. Service ê·œì¹™

```java
@Service
@RequiredArgsConstructor  // âœ… Lombok ìƒì„±ì ì£¼ì…
@Transactional(readOnly = true)  // âœ… ê¸°ë³¸ readOnly
public class UserProfileService {
    
    private final UserProfileRepository userProfileRepository;
    
    @Transactional  // âœ… ì“°ê¸° ì‘ì—…ë§Œ @Transactional
    public UserProfileResponse updateProfile(CustomUuid userUuid, UpdateRequest request) {
        UserProfile profile = userProfileRepository.findByUserUuid(userUuid)
            .orElseThrow(() -> new IllegalArgumentException("í”„ë¡œí•„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
        
        profile.updateTimezone(request.getTimezone());
        
        UserProfile saved = userProfileRepository.save(profile);
        return UserProfileResponse.from(saved);
    }
}
```

---

### 4. Controller ê·œì¹™

```java
@RestController
@RequestMapping("/api/users")
@RequiredArgsConstructor
public class UserProfileController {
    
    private final UserProfileService userProfileService;
    
    @GetMapping("/me/profile")
    public ResponseEntity<ApiSuccessResponse<UserProfileResponse>> getMyProfile(
        @LoginUser LoginUserDto user  // âœ… ì»¤ìŠ¤í…€ ì• ë…¸í…Œì´ì…˜
    ) {
        UserProfileResponse response = userProfileService.getOrCreateProfile(user.getUserUuid());
        return ResponseEntity.ok(
            ApiSuccessResponse.of("í”„ë¡œí•„ì„ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤", response)
        );
    }
    
    @PutMapping("/me/profile")
    public ResponseEntity<ApiSuccessResponse<UserProfileResponse>> updateMyProfile(
        @LoginUser LoginUserDto user,
        @Valid @RequestBody UpdateUserProfileRequest request  // âœ… @Valid ê²€ì¦
    ) {
        UserProfileResponse response = userProfileService.updateProfile(user.getUserUuid(), request);
        return ResponseEntity.ok(
            ApiSuccessResponse.of("í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤", response)
        );
    }
}
```

**í•µì‹¬:**
- RESTful API ì„¤ê³„ (GET, POST, PUT, DELETE)
- `@Valid` í•„ìˆ˜ ì‚¬ìš©
- `@LoginUser` ì»¤ìŠ¤í…€ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì¸ì¦ ì²˜ë¦¬
- ê³µí†µ ì‘ë‹µ: `ApiSuccessResponse<T>`, `ApiErrorResponse`

---

### 5. DTO ê·œì¹™

```java
// Request DTO
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UpdateUserProfileRequest {
    
    @Pattern(regexp = "^[A-Za-z/_]+$", message = "ì˜¬ë°”ë¥¸ ì‹œê°„ëŒ€ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤")
    private String timezone;
    
    @Pattern(regexp = "^[a-z]{2}$", message = "ì–¸ì–´ ì½”ë“œëŠ” 2ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤")
    private String language;
}

// Response DTO
@Getter
@Builder
public class UserProfileResponse {
    private String userUuid;
    private String timezone;
    private String language;
    
    public static UserProfileResponse from(UserProfile profile) {
        return UserProfileResponse.builder()
            .userUuid(profile.getUserUuid().getValue())
            .timezone(profile.getTimezone())
            .language(profile.getLanguage())
            .build();
    }
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### í†µí•© í…ŒìŠ¤íŠ¸ (Controller)

```java
@SpringBootTest
@AutoConfigureMockMvc
@ExtendWith(DatabaseCleanupExtension.class)  // âœ… í•„ìˆ˜
@DisplayName("ì‚¬ìš©ì í”„ë¡œí•„ ì»¨íŠ¸ë¡¤ëŸ¬ í†µí•© í…ŒìŠ¤íŠ¸")
class UserProfileControllerTest {
    
    @Autowired private MockMvc mockMvc;
    @Autowired private UserRepository userRepository;
    
    @Test
    @DisplayName("í”„ë¡œí•„ ì¡°íšŒ - ì„±ê³µ")
    void getProfile_Success() throws Exception {
        // Given: ì‹¤ì œ DBì— ë°ì´í„° ìƒì„±
        User user = userRepository.save(createUser());
        
        // When: API í˜¸ì¶œ (ì‹¤ì œ ì»¤ë°‹ ë°œìƒ)
        mockMvc.perform(get("/api/users/me/profile")
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.data.userUuid").value(user.getUuid().getValue()));
        
        // Then: DB ìƒíƒœ ê²€ì¦
        assertThat(userRepository.findByUuid(user.getUuid())).isPresent();
    }
    // DatabaseCleanupExtensionì´ ìë™ìœ¼ë¡œ í…Œì´ë¸” ì •ë¦¬
}
```

**í•µì‹¬ ì›ì¹™:**
- âœ… **@SpringBootTest ì‚¬ìš©** (ì‹¤ì œ Spring ì»¨í…ìŠ¤íŠ¸)
- âœ… **ì‹¤ì œ Bean ì‚¬ìš©** (Service, Repository ëª¨ë‘ ì‹¤ì œ)
- âœ… **ì‹¤ì œ DB ì‚¬ìš©** (H2 í…ŒìŠ¤íŠ¸ DB)
- âœ… **ì™¸ë¶€ APIë§Œ ëª¨í‚¹** (ìš°ë¦¬ê°€ ì œì–´ ë¶ˆê°€ëŠ¥í•œ ê²ƒë§Œ)
- âœ… **@ExtendWith(DatabaseCleanupExtension.class)** í•„ìˆ˜
- âŒ **@Transactional ì‚¬ìš© ê¸ˆì§€** (ì‹¤ì œ ì»¤ë°‹ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´)

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤

### Flyway ë§ˆì´ê·¸ë ˆì´ì…˜

```sql
-- V1__init.sql
CREATE TABLE user_profiles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_uuid VARCHAR(36) NOT NULL UNIQUE,
    timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Seoul',
    language VARCHAR(2) NOT NULL DEFAULT 'ko',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME,
    deleted_at DATETIME,
    INDEX idx_user_uuid (user_uuid),
    INDEX idx_deleted_at (deleted_at)
);
```

**ê·œì¹™:**
- íŒŒì¼ëª…: `V{version}__{description}.sql`
- í…Œì´ë¸”/ì»¬ëŸ¼: `snake_case`
- PK: `id BIGINT AUTO_INCREMENT`
- UUID: `VARCHAR(36)` + UNIQUE ì¸ë±ìŠ¤
- Soft Delete: `deleted_at DATETIME`
- ìƒì„±/ìˆ˜ì • ì‹œê°„: `created_at`, `updated_at`
- í•„ìš”í•œ ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ì¶”ê°€

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ì ˆëŒ€ ê¸ˆì§€ âŒ

1. **Production DB ì§ì ‘ ìˆ˜ì • ê¸ˆì§€**
   - ë°˜ë“œì‹œ Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œë§Œ ìŠ¤í‚¤ë§ˆ ë³€ê²½

2. **í’€íŒ¨í‚¤ì§€ ê²½ë¡œ ì‚¬ìš© ê¸ˆì§€**
   ```java
   // âŒ ë‚˜ì¨
   org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration.class
   
   // âœ… ì¢‹ìŒ
   import org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration;
   UserDetailsServiceAutoConfiguration.class
   ```

3. **@Transactional í…ŒìŠ¤íŠ¸ ê¸ˆì§€**
   - í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œëŠ” `DatabaseCleanupExtension` ì‚¬ìš©

4. **Service/Repository ëª¨í‚¹ ê¸ˆì§€**
   - ì™¸ë¶€ APIë§Œ ëª¨í‚¹
   - ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ëŠ” ì‹¤ì œ ë¹ˆ ì‚¬ìš©

---

## ğŸ“ ì»¤ë°‹ ê·œì¹™

- **ì‹ ê·œ ì½”ë“œ = í…ŒìŠ¤íŠ¸ í•„ìˆ˜**
  - Controller ì¶”ê°€ â†’ í†µí•© í…ŒìŠ¤íŠ¸ ì¶”ê°€
  - Service ì¶”ê°€ â†’ ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸ ì¶”ê°€
  - Repository ì¶”ê°€ â†’ í…ŒìŠ¤íŠ¸ ì¶”ê°€

- **ì»¤ë°‹ ì „ í™•ì¸**
  ```bash
  ./gradlew test  # ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
  ```

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

1. **ê³„ì¸µ ë¶„ë¦¬**: Presentation â†’ Application â†’ Domain â†’ Infrastructure
2. **snake_case**: ëª¨ë“  DB í…Œì´ë¸”/ì»¬ëŸ¼
3. **UUID ê¸°ë°˜**: í…Œì´ë¸” ê°„ ê´€ê³„
4. **Soft Delete**: `deleted_at` ì‚¬ìš©
5. **Flyway**: ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œë§Œ
6. **ì‹¤ì œ í†µí•© í…ŒìŠ¤íŠ¸**: @SpringBootTest + DatabaseCleanupExtension
7. **ì™¸ë¶€ë§Œ ëª¨í‚¹**: ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ëŠ” ì‹¤ì œ ë¹ˆ ì‚¬ìš©
8. **í…ŒìŠ¤íŠ¸ í•„ìˆ˜**: ëª¨ë“  ì‹ ê·œ ì½”ë“œëŠ” í…ŒìŠ¤íŠ¸ì™€ í•¨ê»˜
