---
alwaysApply: true
description: ìš°ë¦¬ì§‘ ê°€ê³„ë¶€ ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ê°œë°œ ê·œì¹™ ë° ì»¨ë²¤ì…˜
version: "1.0"
---

# ìš°ë¦¬ì§‘ ê°€ê³„ë¶€ Backend - Spring Boot ê°œë°œ ê·œì¹™

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

- **Framework**: Spring Boot 3.x + Java 21
- **Build Tool**: Gradle (Version Catalogs)
- **Database**: MySQL 8.0+
- **ORM**: Spring Data JPA (Hibernate)
- **Migration**: Flyway
- **API Docs**: SpringDoc OpenAPI 3.0
- **Deployment**: Railway

---

## ğŸ“‚ íŒ¨í‚¤ì§€ êµ¬ì¡°

### Layered Architecture

```
com/bifos/accountbook/
â”œâ”€â”€ config/                    # Spring í”„ë ˆì„ì›Œí¬ ì„¤ì •
â”‚   â”œâ”€â”€ AsyncConfig.java
â”‚   â”œâ”€â”€ CorsProperties.java
â”‚   â”œâ”€â”€ OpenApiConfig.java
â”‚   â”œâ”€â”€ QueryDslConfig.java
â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â””â”€â”€ WebMvcConfig.java
â”‚
â”œâ”€â”€ presentation/              # REST API ë ˆì´ì–´
â”‚   â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ annotation/
â”‚   â””â”€â”€ resolver/
â”‚
â”œâ”€â”€ application/               # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë ˆì´ì–´
â”‚   â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ dto/
â”‚   â””â”€â”€ event/
â”‚
â”œâ”€â”€ domain/                    # ë„ë©”ì¸ ë ˆì´ì–´
â”‚   â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ repository/           # ì¸í„°í˜ì´ìŠ¤ë§Œ
â”‚   â””â”€â”€ value/                # Value Object
â”‚
â”œâ”€â”€ infra/                     # Infrastructure ë ˆì´ì–´
â”‚   â”œâ”€â”€ persistence/          # DB ì ‘ê·¼ (Repository êµ¬í˜„ì²´)
â”‚   â”œâ”€â”€ security/             # ë³´ì•ˆ êµ¬í˜„ (JWT, í•„í„°)
â”‚   â”œâ”€â”€ filter/               # HTTP í•„í„°
â”‚   â”œâ”€â”€ exception/            # ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬
â”‚   â””â”€â”€ event/                # ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
â”‚
â””â”€â”€ common/                    # ê³µí†µ ìœ í‹¸ë¦¬í‹°
    â””â”€â”€ exception/
```

### íŒ¨í‚¤ì§€ë³„ ì—­í• 

| íŒ¨í‚¤ì§€ | ì—­í•  | ì˜ˆì‹œ |
|--------|------|------|
| `config/` | Spring í”„ë ˆì„ì›Œí¬ ì„¤ì • | Security, WebMvc, QueryDSL |
| `presentation/` | HTTP ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬ | Controller, DTO, Resolver |
| `application/` | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ | Service, DTO, Event |
| `domain/` | ë„ë©”ì¸ ëª¨ë¸ | Entity, Repository Interface |
| `infra/` | ì™¸ë¶€ ì‹œìŠ¤í…œ í†µí•© | DB, Security êµ¬í˜„ì²´ |

---

## âš™ï¸ Config ê´€ë¦¬ ê·œì¹™

### 1. ConfigurationProperties íŒ¨í„´

**âœ… ì˜¬ë°”ë¥¸ ë°©ë²•:**

```java
@Getter
@ConfigurationProperties(prefix = "cors")
public class CorsProperties {

    private final List<String> allowedOrigins;
    private final boolean allowCredentials;
    private final long maxAge;

    /**
     * Constructor Binding (Spring Boot 3.x ìë™ ì ìš©)
     * ëª¨ë“  ê°’ì€ application.ymlì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
     */
    public CorsProperties(
            List<String> allowedOrigins,
            boolean allowCredentials,
            long maxAge
    ) {
        this.allowedOrigins = allowedOrigins;
        this.allowCredentials = allowCredentials;
        this.maxAge = maxAge;
    }
}
```

**application.yml:**

```yaml
cors:
  allowed-origins:
    - http://localhost:3000
    - https://your-domain.vercel.app
  allowed-credentials: true
  max-age: 3600
```

**âŒ í”¼í•´ì•¼ í•  íŒ¨í„´:**

```java
// âŒ @Setter ì‚¬ìš© ê¸ˆì§€ (ëŸ°íƒ€ì„ ë³€ê²½ ê°€ëŠ¥)
@Setter
private List<String> allowedOrigins;

// âŒ ì½”ë“œì— ê¸°ë³¸ê°’ í•˜ë“œì½”ë”© ê¸ˆì§€
this.allowedOrigins = allowedOrigins != null ? allowedOrigins : 
    List.of("http://localhost:3000");

// âŒ @Component ì‚¬ìš© ê¸ˆì§€ (ìë™ ë¹ˆ ë“±ë¡ ë¶ˆí•„ìš”)
@Component
@ConfigurationProperties(prefix = "cors")
public class CorsProperties { }
```

### 2. Config í´ë˜ìŠ¤ ì‘ì„± ê·œì¹™

```java
/**
 * Spring Security ì„¤ì •
 * 
 * ê´€ë ¨ Properties: CorsProperties, JwtProperties
 * ì˜ì¡´ì„±: JwtAuthenticationFilter, NextAuthTokenFilter
 */
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthenticationFilter;
    private final CorsProperties corsProperties;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        // ì„¤ì • ë¡œì§
        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        // CORS ì„¤ì •ì€ CorsPropertiesì—ì„œ ì£¼ì…
        configuration.setAllowedOrigins(corsProperties.getAllowedOrigins());
        return source;
    }
}
```

### 3. application.yml êµ¬ì¡°

```yaml
# ============================================
# ê³µí†µ ì„¤ì • (ëª¨ë“  í”„ë¡œíŒŒì¼ì— ì ìš©)
# ============================================

server:
  port: ${PORT:8080}

spring:
  application:
    name: fos-accountbook-backend

# JWT ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜)
jwt:
  secret: ${AUTH_SECRET}
  expiration: ${JWT_EXPIRATION:86400000}      # 24ì‹œê°„
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000} # 7ì¼

# CORS ì„¤ì • (ê¸°ë³¸ê°’ ì œê³µ)
cors:
  allowed-origins: []  # í”„ë¡œíŒŒì¼ë³„ ì˜¤ë²„ë¼ì´ë“œ í•„ìˆ˜
  allowed-methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
  allowed-headers:
    - Authorization
    - Content-Type
  allow-credentials: true
  max-age: 3600  # 1ì‹œê°„
```

### 4. Config í´ë˜ìŠ¤ ë°°ì¹˜ ì›ì¹™

| ì„¤ì • íƒ€ì… | ìœ„ì¹˜ | ì˜ˆì‹œ |
|-----------|------|------|
| Spring í”„ë ˆì„ì›Œí¬ ì„¤ì • | `config/` | SecurityConfig, WebMvcConfig |
| Properties í´ë˜ìŠ¤ | `config/` | CorsProperties, JwtProperties |
| Infrastructure êµ¬í˜„ | `infra/security/` | JwtAuthenticationFilter |
| DB ê´€ë ¨ | `infra/persistence/` | Repository êµ¬í˜„ì²´ |

---

## ğŸ“ ì½”ë”© ì»¨ë²¤ì…˜

### 1. Entity ê·œì¹™

```java
@Entity
@Table(name = "expenses")  // âœ… snake_case í•„ìˆ˜
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Expense {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;  // âœ… PKëŠ” Long auto_increment

    @Column(name = "uuid", unique = true, nullable = false)
    private CustomUuid uuid;  // âœ… UUID íƒ€ì…

    @Column(name = "family_uuid", nullable = false)
    private CustomUuid familyUuid;  // âœ… ê´€ê³„ëŠ” UUID ê¸°ë°˜

    @Column(name = "amount", nullable = false)
    private BigDecimal amount;

    @Column(name = "created_at", nullable = false)
    private LocalDateTime createdAt;

    @Column(name = "deleted_at")  // âœ… Soft Delete
    private LocalDateTime deletedAt;
}
```

### 2. DTO ê·œì¹™

```java
// Request DTO
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CreateExpenseRequest {

    @NotNull(message = "ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Positive(message = "ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤")
    private BigDecimal amount;

    @NotBlank(message = "ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String categoryUuid;

    @Size(max = 1000, message = "ì„¤ëª…ì€ 1000ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
    private String description;
}

// Response DTO
@Getter
@Builder
public class ExpenseResponse {
    private String uuid;
    private BigDecimal amount;
    private String categoryName;
    private LocalDateTime date;

    public static ExpenseResponse from(Expense expense) {
        return ExpenseResponse.builder()
            .uuid(expense.getUuid().getValue())
            .amount(expense.getAmount())
            .build();
    }
}
```

**í•µì‹¬ ì›ì¹™:**
- âŒ `@Data` ì‚¬ìš© ê¸ˆì§€ (ë¶ˆë³€ì„± ìœ„ë°˜)
- âœ… `@Getter` + `@Builder` + `@NoArgsConstructor` + `@AllArgsConstructor`
- âœ… Setter ì—†ì´ ë¶ˆë³€ ê°ì²´ë¡œ ê´€ë¦¬
- âœ… `from()` ì •ì  íŒ©í† ë¦¬ ë©”ì„œë“œë¡œ ë³€í™˜

### 3. Service ê·œì¹™

```java
@Service
@RequiredArgsConstructor  // âœ… Lombok ìƒì„±ì ì£¼ì…
@Transactional(readOnly = true)  // âœ… ê¸°ë³¸ readOnly
public class ExpenseService {

    private final ExpenseRepository expenseRepository;
    private final CategoryRepository categoryRepository;

    @Transactional  // âœ… ì“°ê¸° ì‘ì—…ë§Œ @Transactional
    public ExpenseResponse createExpense(
            CustomUuid userUuid,
            String familyUuid,
            CreateExpenseRequest request
    ) {
        // 1. ê²€ì¦
        Category category = categoryRepository.findByUuid(request.getCategoryUuid())
            .orElseThrow(() -> new BusinessException(ErrorCode.CATEGORY_NOT_FOUND));

        // 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        Expense expense = Expense.builder()
            .uuid(CustomUuid.generate())
            .amount(request.getAmount())
            .build();

        // 3. ì €ì¥
        Expense saved = expenseRepository.save(expense);

        return ExpenseResponse.from(saved);
    }
}
```

### 4. Controller ê·œì¹™

```java
@RestController
@RequestMapping("/api/v1/families/{familyUuid}/expenses")
@RequiredArgsConstructor
public class ExpenseController {

    private final ExpenseService expenseService;

    @PostMapping
    public ResponseEntity<ApiSuccessResponse<ExpenseResponse>> createExpense(
        @LoginUser LoginUserDto user,  // âœ… ì»¤ìŠ¤í…€ ì• ë…¸í…Œì´ì…˜
        @PathVariable String familyUuid,
        @Valid @RequestBody CreateExpenseRequest request  // âœ… @Valid ê²€ì¦
    ) {
        ExpenseResponse response = expenseService.createExpense(
            user.getUserUuid(),
            familyUuid,
            request
        );

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .body(ApiSuccessResponse.of("ì§€ì¶œì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤", response));
    }
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### í†µí•© í…ŒìŠ¤íŠ¸ (Controller)

```java
@SpringBootTest
@AutoConfigureMockMvc
@ExtendWith(DatabaseCleanupExtension.class)  // âœ… í•„ìˆ˜
@DisplayName("ì§€ì¶œ ì»¨íŠ¸ë¡¤ëŸ¬ í†µí•© í…ŒìŠ¤íŠ¸")
class ExpenseControllerTest {

    @Autowired private MockMvc mockMvc;
    @Autowired private ExpenseRepository expenseRepository;

    @Test
    @DisplayName("ì§€ì¶œ ìƒì„± - ì„±ê³µ")
    void createExpense_Success() throws Exception {
        // Given: ì‹¤ì œ DBì— ë°ì´í„° ìƒì„±
        String requestBody = objectMapper.writeValueAsString(request);

        // When: API í˜¸ì¶œ (ì‹¤ì œ ì»¤ë°‹ ë°œìƒ)
        mockMvc.perform(post("/api/v1/families/{familyUuid}/expenses", familyUuid)
                .contentType(MediaType.APPLICATION_JSON)
                .content(requestBody))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.data.amount").value(50000));

        // Then: DB ìƒíƒœ ê²€ì¦
        List<Expense> expenses = expenseRepository.findAll();
        assertThat(expenses).hasSize(1);
    }
    // DatabaseCleanupExtensionì´ ìë™ìœ¼ë¡œ í…Œì´ë¸” ì •ë¦¬
}
```

**í•µì‹¬ ì›ì¹™:**
- âœ… `@SpringBootTest` ì‚¬ìš© (ì‹¤ì œ Spring ì»¨í…ìŠ¤íŠ¸)
- âœ… ì‹¤ì œ Bean ì‚¬ìš© (Service, Repository ëª¨ë‘ ì‹¤ì œ)
- âœ… ì‹¤ì œ DB ì‚¬ìš© (H2 í…ŒìŠ¤íŠ¸ DB)
- âœ… ì™¸ë¶€ APIë§Œ ëª¨í‚¹
- âœ… `@ExtendWith(DatabaseCleanupExtension.class)` í•„ìˆ˜
- âŒ `@Transactional` ì‚¬ìš© ê¸ˆì§€ (ì‹¤ì œ ì»¤ë°‹ í…ŒìŠ¤íŠ¸)

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤

### Flyway ë§ˆì´ê·¸ë ˆì´ì…˜

```sql
-- V1__init.sql
CREATE TABLE expenses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    uuid VARCHAR(36) NOT NULL UNIQUE,
    family_uuid VARCHAR(36) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME,
    deleted_at DATETIME,
    INDEX idx_family_uuid (family_uuid),
    INDEX idx_deleted_at (deleted_at)
);
```

**ê·œì¹™:**
- íŒŒì¼ëª…: `V{version}__{description}.sql`
- í…Œì´ë¸”/ì»¬ëŸ¼: `snake_case`
- PK: `id BIGINT AUTO_INCREMENT`
- UUID: `VARCHAR(36)` + UNIQUE ì¸ë±ìŠ¤
- Soft Delete: `deleted_at DATETIME`
- í•„ìš”í•œ ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ì¶”ê°€

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ì ˆëŒ€ ê¸ˆì§€ âŒ

1. **Production DB ì§ì ‘ ìˆ˜ì • ê¸ˆì§€**
   - ë°˜ë“œì‹œ Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œë§Œ ìŠ¤í‚¤ë§ˆ ë³€ê²½

2. **í’€íŒ¨í‚¤ì§€ ê²½ë¡œ ì‚¬ìš© ê¸ˆì§€**
   ```java
   // âŒ ë‚˜ì¨
   org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration.class

   // âœ… ì¢‹ìŒ
   import org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration;
   UserDetailsServiceAutoConfiguration.class
   ```

3. **@Transactional í…ŒìŠ¤íŠ¸ ê¸ˆì§€**
   - í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œëŠ” `DatabaseCleanupExtension` ì‚¬ìš©

4. **Service/Repository ëª¨í‚¹ ê¸ˆì§€**
   - ì™¸ë¶€ APIë§Œ ëª¨í‚¹
   - ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ëŠ” ì‹¤ì œ ë¹ˆ ì‚¬ìš©

---

## ğŸ“ ì»¤ë°‹ ê·œì¹™

- **ì‹ ê·œ ì½”ë“œ = í…ŒìŠ¤íŠ¸ í•„ìˆ˜**
  - Controller ì¶”ê°€ â†’ í†µí•© í…ŒìŠ¤íŠ¸ ì¶”ê°€
  - Service ì¶”ê°€ â†’ ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸ ì¶”ê°€

- **ì»¤ë°‹ ì „ í™•ì¸**
  ```bash
  ./gradlew test  # ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
  ```

---

## ğŸ¯ í•µì‹¬ ì›ì¹™

1. **ê³„ì¸µ ë¶„ë¦¬**: Presentation â†’ Application â†’ Domain â†’ Infrastructure
2. **snake_case**: ëª¨ë“  DB í…Œì´ë¸”/ì»¬ëŸ¼
3. **UUID ê¸°ë°˜**: í…Œì´ë¸” ê°„ ê´€ê³„
4. **Soft Delete**: `deleted_at` ì‚¬ìš©
5. **Flyway**: ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œë§Œ
6. **ì‹¤ì œ í†µí•© í…ŒìŠ¤íŠ¸**: @SpringBootTest + DatabaseCleanupExtension
7. **ì™¸ë¶€ë§Œ ëª¨í‚¹**: ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ëŠ” ì‹¤ì œ ë¹ˆ ì‚¬ìš©
8. **Config ì¤‘ì•™í™”**: ëª¨ë“  ì„¤ì •ì€ application.ymlì—ì„œ ê´€ë¦¬
9. **ë¶ˆë³€ì„±**: ConfigurationPropertiesì™€ DTOëŠ” ë¶ˆë³€ ê°ì²´ë¡œ
